---
# Configuraci√≥n del servidor Nagios

#- name: Copy apache2.conf to /etc/nagios3 (Debian)
#  template: src=etc/nagios3/apache2.conf.j2 dest=/etc/nagios3/apache2.conf owner=root group=root mode=0644
#  notify: restart apache
#  when: ansible_os_family == "Debian"

- name: Copy nagios.conf to /etc/httpd/conf.d (Centos)
  template: src=etc/httpd/conf.d/nagios.conf.j2 dest=/etc/httpd/conf.d/nagios.conf owner=root group=root mode=0644
  notify: restart apache
  when: ansible_os_family == "RedHat" 

- name: Configure check_external_command in /etc/nagios3/nagios.cfg file
  lineinfile: name=/etc/nagios3/nagios.cfg state=present regexp='^check_external_commands' line='check_external_commands=1'
  notify: restart nagios

- name: Configure use_authentication in /etc/nagios3/cgi.cfg file
  lineinfile: name=/etc/nagios3/cgi.cfg state=present regexp='^use_authentication' line='use_authentication=1'
  notify: restart nagios 

- name: Configure authorized access in /etc/nagios3/cgi.cfg file
  lineinfile: name=/etc/nagios3/cgi.cfg state=present regexp={{ item.find }} line={{ item.new }}
  with_items:
     - { find: '^authorized_for_system_information', new: 'authorized_for_system_information=*' }
     - { find: '^authorized_for_configuration_information', new: 'authorized_for_configuration_information=*' }
     - { find: '^authorized_for_system_commands', new: 'authorized_for_system_commands=*' }
     - { find: '^authorized_for_all_services', new: 'authorized_for_all_services=*' }
     - { find: '^authorized_for_all_hosts', new: 'authorized_for_all_hosts=*' }
     - { find: '^authorized_for_all_service_commands', new: 'authorized_for_all_service_commands=*' }
     - { find: '^authorized_for_all_host_commands', new: 'authorized_for_all_host_commands=*' }
  notify: restart nagios

- name: Copy /etc/nagios3/objects/command-nrpe.cfg file (Definition of check_nrpe_1arg command) (Centos)
  template: src=etc/nagios3/objects/command-nrpe.cfg.j2 dest=/etc/nagios3/objects/command-nrpe.cfg owner=root group=root mode=0664
  notify: restart nagios
  when: ansible_os_family == "RedHat" 

- name: Configure /etc/nagios3/nagios.cfg file (Centos)
  lineinfile: name=/etc/nagios3/nagios.cfg state=present regexp='^cfg_file=/etc/nagios3/objects/command-nrpe.cfg' line='cfg_file=/etc/nagios3/objects/command-nrpe.cfg'
  notify: restart nagios
  when: ansible_os_family == "RedHat" 

- name: Add userApache to nagios group
  user: name={{ userApache }} state=present groups=nagios

- name: Comment localhost in /etc/nagios3/nagios.cfg file with 'host_name localhost.localdomain' (Centos)
  lineinfile: name=/etc/nagios3/nagios.cfg state=present regexp="^#?cfg_file=/etc/nagios/objects/localhost.cfg" line='#cfg_file=/etc/nagios/objects/localhost.cfg'
  notify: restart nagios
  when: ansible_os_family == "RedHat" 

#- name: Copy template 'linux-server' to /etc/nagios3/conf.d (Debian)
#  template: src=etc/nagios3/conf.d/linux-server_ansible.cfg.j2 dest=/etc/nagios3/conf.d/linux-server_ansible.cfg owner=root group=root mode=0644
#  when: ansible_os_family == "Debian"

#- name: Delete localhost_ansible.cfg in /etc/nagios3/conf.d (Debian) 
#  file: path={{ item }} state=absent
#  with_items:
#    - /etc/nagios3/conf.d/localhost_ansible.cfg 
#    - /etc/nagios3/conf.d/hostgroups_ansible.cfg
#    - /etc/nagios3/conf.d/services_ansible.cfg
#    - /etc/nagios3/conf.d/extinfo_ansible.cfg
#  notify: restart nagios
#  when: ansible_os_family == "Debian"

- name: Copy localhost to /etc/nagios3/conf.d
  template: src=etc/nagios3/conf.d/localhost_ansible.cfg.j2 dest=/etc/nagios3/conf.d/localhost_ansible.cfg owner=root group=root mode=0644
  notify: restart nagios

#- name: Change permissions to /var/lib/nagios3/rw directory (Debian) 
#  shell: chmod -R 770 /var/lib/nagios3/rw
#  when: ansible_os_family == "Debian"

