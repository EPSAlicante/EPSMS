{# The source code packaged with this file is Free Software, Copyright (C) 2016 by #}
{# Unidad de Laboratorios, Escuela Politecnica Superior, Universidad de Alicante :: <epsms at eps.ua.es>. #}
{# It's licensed under the AFFERO GENERAL PUBLIC LICENSE unless stated otherwise. #}
{# You can get copies of the licenses here: http://www.affero.org/oagpl.html #}
{# AFFERO GENERAL PUBLIC LICENSE is also included in the file called "LICENSE". #}
{#                                                                              #}
{#                                                                              #}
# Generating SQL for Openvas Results of {{ openvas.Server }}

CHECK_OPENVASHOST: SELECT * FROM OpenvasHost WHERE OpenvasHost.Server='{{ openvas.Server }}' AND OpenvasHost.ScanId='{{ openvas.ScanId }}' AND OpenvasHost.IP='{{ openvas.IP }}' AND OpenvasHost.StartScan='{{ startScan.stdout }}' AND OpenvasHost.CVSS='{{ openvas.CVSS }}' AND OpenvasHost.Severity='{{ openvas.Severity }}' AND OpenvasHost.TotalHigh='{{ openvas.TotalHigh }}' AND OpenvasHost.TotalMedium='{{ openvas.TotalMedium }}' AND OpenvasHost.TotalLow='{{ openvas.TotalLow }}' AND OpenvasHost.TotalLog='{{ openvas.TotalLog }}' AND OpenvasHost.TotalFalsePositive='{{ openvas.TotalFalsePositive }}' AND OpenvasHost.ReportHTML='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.html' AND OpenvasHost.ReportPDF='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.pdf' AND OpenvasHost.ReportTXT='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.txt' AND OpenvasHost.ReportXML='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.xml' AND OpenvasHost.Auto AND OpenvasHost.End IS NULL;

UPDATE_OPENVASHOST: UPDATE OpenvasHost SET Checked=NOW() WHERE OpenvasHost.Server='{{ openvas.Server }}' AND OpenvasHost.ScanId='{{ openvas.ScanId }}' AND OpenvasHost.IP='{{ openvas.IP }}' AND OpenvasHost.StartScan='{{ startScan.stdout }}' AND OpenvasHost.CVSS='{{ openvas.CVSS }}' AND OpenvasHost.Severity='{{ openvas.Severity }}' AND OpenvasHost.TotalHigh='{{ openvas.TotalHigh }}' AND OpenvasHost.TotalMedium='{{ openvas.TotalMedium }}' AND OpenvasHost.TotalLow='{{ openvas.TotalLow }}' AND OpenvasHost.TotalLog='{{ openvas.TotalLog }}' AND OpenvasHost.TotalFalsePositive='{{ openvas.TotalFalsePositive }}' AND OpenvasHost.ReportHTML='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.html' AND OpenvasHost.ReportPDF='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.pdf' AND OpenvasHost.ReportTXT='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.txt' AND OpenvasHost.ReportXML='https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.xml' AND OpenvasHost.Auto AND OpenvasHost.End IS NULL;

INSERT_OPENVASHOST: INSERT INTO OpenvasHost (Server,ScanId,IP,StartScan,CVSS,Severity,TotalHigh,TotalMedium,TotalLow,TotalLog,TotalFalsePositive,ReportHTML,ReportPDF,ReportTXT,ReportXML,Init,Checked,Auto) VALUES ('{{ openvas.Server }}', '{{ openvas.ScanId }}', '{{ openvas.IP }}', '{{ startScan.stdout }}', '{{ openvas.CVSS }}', '{{ openvas.Severity }}', '{{ openvas.TotalHigh }}', '{{ openvas.TotalMedium }}', '{{ openvas.TotalLow }}', '{{ openvas.TotalLog }}', '{{ openvas.TotalFalsePositive }}', 'https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.html', 'https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.pdf', 'https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.txt', 'https://{{ hostnameWeb }}/openvas-reports/{{ openvas.Server }}/{{ openvas.Server }}-{{ startScan.stdout }}.xml', NOW(), NOW(), 1);

{% for result in openvas.Results -%}

CHECK_OPENVASRESULT_{{ result["Id"] }}: SELECT * FROM OpenvasResult WHERE OpenvasResult.Server='{{ openvas.Server }}' AND OpenvasResult.ScanId='{{ openvas.ScanId }}' AND OpenvasResult.Id={{ result["Id"] }} AND OpenvasResult.TaskId='{{ result["TaskId"] }}' AND OpenvasResult.TaskName='{{ result["TaskName"] }}' AND OpenvasResult.StartScan='{{ result["StartScan"] }}' AND OpenvasResult.ResultId='{{ result["ResultId"] }}' AND OpenvasResult.Port='{{ result["Port"] }}' AND OpenvasResult.Protocol='{{ result["Protocol"] }}' AND OpenvasResult.CVSS='{{ result["CVSS"] }}' AND OpenvasResult.Severity='{{ result["Severity"] }}' AND OpenvasResult.NVTName='{{ result["NVTName"] }}' AND OpenvasResult.NVTOID='{{ result["NVTOID"] }}' AND OpenvasResult.Summary='{{ result["Summary"] }}' AND OpenvasResult.SpecificResult='{{ result["SpecificResult"] }}' AND OpenvasResult.Impact='{{ result["Impact"] }}' AND OpenvasResult.Solution='{{ result["Solution"] }}' AND OpenvasResult.AffectedSoftware='{{ result["AffectedSoftware"] }}' AND OpenvasResult.VulnerabilityInsight='{{ result["VulnerabilityInsight"] }}' AND OpenvasResult.DetectionMethod='{{ result["DetectionMethod"] }}' AND OpenvasResult.ProductDetectionResult='{{ result["ProductDetectionResult"] }}' AND OpenvasResult.BID='{{ result["BID"] }}' AND OpenvasResult.CVE='{{ result["CVE"] }}' AND OpenvasResult.CERT='{{ result["CERT"] }}' AND OpenvasResult.OtherRef='{{ result["OtherRef"] }}' AND OpenvasResult.Auto AND OpenvasResult.End IS NULL;

UPDATE_OPENVASRESULT_{{ result["Id"] }}: UPDATE OpenvasResult SET Checked=NOW() WHERE OpenvasResult.Server='{{ openvas.Server }}' AND OpenvasResult.ScanId='{{ openvas.ScanId }}' AND OpenvasResult.Id={{ result["Id"] }} AND OpenvasResult.TaskId='{{ result["TaskId"] }}' AND OpenvasResult.TaskName='{{ result["TaskName"] }}' AND OpenvasResult.StartScan='{{ result["StartScan"] }}' AND OpenvasResult.ResultId='{{ result["ResultId"] }}' AND OpenvasResult.Port='{{ result["Port"] }}' AND OpenvasResult.Protocol='{{ result["Protocol"] }}' AND OpenvasResult.CVSS='{{ result["CVSS"] }}' AND OpenvasResult.Severity='{{ result["Severity"] }}' AND OpenvasResult.NVTName='{{ result["NVTName"] }}' AND OpenvasResult.NVTOID='{{ result["NVTOID"] }}' AND OpenvasResult.Summary='{{ result["Summary"] }}' AND OpenvasResult.SpecificResult='{{ result["SpecificResult"] }}' AND OpenvasResult.Impact='{{ result["Impact"] }}' AND OpenvasResult.Solution='{{ result["Solution"] }}' AND OpenvasResult.AffectedSoftware='{{ result["AffectedSoftware"] }}' AND OpenvasResult.VulnerabilityInsight='{{ result["VulnerabilityInsight"] }}' AND OpenvasResult.DetectionMethod='{{ result["DetectionMethod"] }}' AND OpenvasResult.ProductDetectionResult='{{ result["ProductDetectionResult"] }}' AND OpenvasResult.BID='{{ result["BID"] }}' AND OpenvasResult.CVE='{{ result["CVE"] }}' AND OpenvasResult.CERT='{{ result["CERT"] }}' AND OpenvasResult.OtherRef='{{ result["OtherRef"] }}' AND OpenvasResult.Auto AND OpenvasResult.End IS NULL; 

INSERT_OPENVASRESULT_{{ result["Id"] }}: INSERT INTO OpenvasResult (Server,ScanId,Id,TaskId,TaskName,StartScan,ResultId,Port,Protocol,CVSS,Severity,NVTName,NVTOID,Summary,SpecificResult,Impact,Solution,AffectedSoftware,VulnerabilityInsight,DetectionMethod,ProductDetectionResult,BID,CVE,CERT,OtherRef,Init,Checked,Auto) VALUES ('{{ openvas.Server }}', '{{ openvas.ScanId }}', {{ result["Id"] }}, '{{ result["TaskId"] }}', '{{ result["TaskName"] }}', '{{ result["StartScan"] }}', '{{ result["ResultId"] }}', '{{ result["Port"] }}', '{{ result["Protocol"] }}', '{{ result["CVSS"] }}', '{{ result["Severity"] }}', '{{ result["NVTName"] }}', '{{ result["NVTOID"] }}', '{{ result["Summary"] }}', '{{ result["SpecificResult"] }}', '{{ result["Impact"] }}', '{{ result["Solution"] }}', '{{ result["AffectedSoftware"] }}', '{{ result["VulnerabilityInsight"] }}', '{{ result["DetectionMethod"] }}', '{{ result["ProductDetectionResult"] }}', '{{ result["BID"] }}', '{{ result["CVE"] }}', '{{ result["CERT"] }}', '{{ result["OtherRef"] }}', NOW(), NOW(), 1);

{% endfor %}

END-CHECK_OPENVASHOST: SELECT * from OpenvasHost WHERE OpenvasHost.Server='{{ openvas.Server }}' AND OpenvasHost.Auto AND OpenvasHost.End IS NULL AND OpenvasHost.Checked<'##checkedTime##';
END-UPDATE_OPENVASHOST: UPDATE OpenvasHost SET End=NOW() WHERE OpenvasHost.Server='{{ openvas.Server }}' AND OpenvasHost.Auto AND OpenvasHost.End IS NULL AND OpenvasHost.Checked<'##checkedTime##';

END-CHECK_OPENVASRESULT: SELECT * from OpenvasResult WHERE OpenvasResult.Server='{{ openvas.Server }}' AND OpenvasResult.Auto AND OpenvasResult.End IS NULL AND OpenvasResult.Checked<'##checkedTime##';
END-UPDATE_OPENVASRESULT: UPDATE OpenvasResult SET End=NOW() WHERE OpenvasResult.Server='{{ openvas.Server }}' AND OpenvasResult.Auto AND OpenvasResult.End IS NULL AND OpenvasResult.Checked<'##checkedTime##';
