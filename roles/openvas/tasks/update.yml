---
# OpenVas Server Update 

- name: Check  openvas
  shell: (openvas-check-setup --v7 > /dev/null && echo "OK") || echo "No" executable=/bin/bash
  register: setupOpenvas
  changed_when: False

- name: Check running tasks
  shell: (omp -u admin -w {{ passwdOpenvas }} -G >/dev/null|grep -i "Running" > /dev/null && echo "Running") || echo "No" executable=/bin/bash
  register: checkTasks
  changed_when: False

- name: Synchronise Network Vulnerability Tests (it can take a long time)
  shell: /usr/bin/expect -c 'spawn openvas-nvt-sync --rsync; expect "Run migration now*"; send "y\r"; interact;' 
  when: checkTasks.stdout == "No"

- name: restart openvas-scanner service
  service: name=openvas-scanner state=restarted enabled=yes
  ignore_errors: yes
  when: checkTasks.stdout == "No"

- name: Synchronise SCAP Feed (it can take a long time)
  shell: openvas-scapdata-sync
  when: checkTasks.stdout == "No"

- name: Synchronise CertData Feed (it can take a long time)
  shell: openvas-certdata-sync
  when: checkTasks.stdout == "No"

- name: Update the manager database (it can take a long time)
  shell: openvasmd --rebuild
  when: checkTasks.stdout == "No"

